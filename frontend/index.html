<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>構図分析ツール</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap" rel="stylesheet">
    <style>
        /* (CSSは変更なしなので省略) */
        body { font-family: 'Quicksand', 'Segoe UI', sans-serif; background: linear-gradient(135deg, #fceabb 0%, #f8b6d2 100%); margin: 0; min-height: 100vh; }
        .container { max-width: 420px; margin: 40px auto; background: #fff8fa; border-radius: 24px; box-shadow: 0 6px 32px rgba(200, 180, 255, 0.18); padding: 2.5em 2em 2em 2em; text-align: center; }
        h1 { color: #ffb6b9; margin-bottom: 0.5em; font-size: 2em; letter-spacing: 0.05em; }
        p { color: #a7a7a7; margin-bottom: 2em; }
        form { margin-bottom: 1.5em; }
        input[type="file"] { border: none; background: #fceabb; padding: 0.7em 1em; border-radius: 12px; font-size: 1em; color: #a67ca7; margin-bottom: 1em; box-shadow: 0 2px 8px rgba(255, 182, 185, 0.08); }
        button[type="submit"] { background: linear-gradient(90deg, #ffb6b9 0%, #fceabb 100%); color: #fff; border: none; border-radius: 16px; padding: 0.7em 2.2em; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 182, 185, 0.18); transition: background 0.2s, transform 0.2s; }
        button[type="submit"]:hover { background: linear-gradient(90deg, #f8b6d2 0%, #fceabb 100%); transform: translateY(-2px) scale(1.04); }
        #spinner { border: 5px solid #fceabb; border-top: 5px solid #ffb6b9; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; display: none; margin: 24px auto; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        #result-area { margin-top: 2em; }
        #result-area h2 { color: #a67ca7; font-size: 1.2em; margin-bottom: 0.5em; }
        .image-box { background: #fceabb; border: 2px dashed #ffb6b9; border-radius: 18px; padding: 1.5em 1em; min-height: 180px; text-align: center; color: #bfa6c9; font-size: 1.1em; box-shadow: 0 2px 8px rgba(255, 182, 185, 0.08); transition: background 0.2s; }
        .image-box img { max-width: 100%; height: auto; margin-top: 1em; border-radius: 12px; box-shadow: 0 2px 12px rgba(246, 187, 233, 0.18); border: 2px solid #fff; }
        /* ★★★ スライダー用の新しいスタイル ★★★ */
        .slider-container { margin: 1em 0; color: #a7a7a7; }
        .slider-container label { display: block; margin-bottom: 0.5em; }
        input[type="range"] { width: 80%; }
        @media (max-width: 600px) { .container { max-width: 98vw; padding: 1em 0.5em 2em 0.5em; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fibonacci Spiral Detection</h1>
        <p>Choose a file to analyze</p>

        <form id="upload-form">
            <input type="file" id="file-input" name="file" accept="image/png, image/jpeg" required>

            <div class="slider-container">
                <label for="k-slider">Number of Clusters (k): <span id="k-value-label">Auto</span></label>
                <input type="range" id="k-slider" name="k" min="0" max="15" value="0">
            </div>
            
            <button type="submit">Analyze</button>
        </form>

        <div id="spinner" class="spinner"></div>

        <div id="result-area">
            <h2>Result</h2>
            <div id="image-result-box" class="image-box">
                Result will be shown here 
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const resultBox = document.getElementById('image-result-box');
        const spinner = document.getElementById('spinner');
        
        // ★★★ スライダーの要素を取得 ★★★
        const kSlider = document.getElementById('k-slider');
        const kValueLabel = document.getElementById('k-value-label');

        // ★★★ スライダーを動かした時にラベル表示を更新する処理 ★★★
        kSlider.addEventListener('input', (event) => {
            const value = event.target.value;
            if (value === '0') {
                kValueLabel.textContent = 'Auto';
            } else {
                kValueLabel.textContent = value;
            }
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const file = fileInput.files[0];
            if (!file) {
                alert('No file selected. Please choose an image file.');
                return;
            }

            // ★★★ スライダーの値を取得 ★★★
            const kValue = kSlider.value;

            const formData = new FormData();
            formData.append('file', file);
            // ★★★ FormDataにkの値も追加する ★★★
            formData.append('k', kValue);

            spinner.style.display = 'block';
            resultBox.innerHTML = '';

            try {
                // ... fetch処理は変更なし ...
                const response = await fetch('http://localhost:3000/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} ${errorText}`);
                }

                const imageBlob = await response.blob();
                const imageUrl = URL.createObjectURL(imageBlob);
                const imageElement = document.createElement('img');
                imageElement.src = imageUrl;
                resultBox.appendChild(imageElement);

            } catch (error) {
                console.error('Error:', error);
                resultBox.textContent = `Error occured: ${error.message}`;
            } finally {
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>